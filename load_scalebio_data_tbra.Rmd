---
title: "load_scalebio_data"
author: "Sara"
date: "2026-01-14"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

## Load data and create seurat object containign all cells for Tg2a+cyt, F12WT & TBRAKO

```{r setup, include=FALSE}
library(Seurat)
```

Scalebio pipeline generates filtered matrices that can be loaded using
Read10x function in Seurat. Only loading pools 2 and 4 as they contain
samples of interest. For each pool a
"Pool(number).QSR-P-SCALEPLEX.scaleplex_stats.csv" file was generated
containing information on the number of cells assigned to each sample.
ScalePlex assignment is also on the metadata

### Load raw data

```{r}
#Load count matrices for each pool 
counts_2 <- Read10X("//csce.datastore.ed.ac.uk/csce/biology/groups/chambers/NGS_data_analysis/Sara/scale_bio_Sara/output_merged/samples/Pool2.QSR-P.filtered.matrix")

counts_4 <- Read10X("//csce.datastore.ed.ac.uk/csce/biology/groups/chambers/NGS_data_analysis/Sara/scale_bio_Sara/output_merged/samples/Pool4.QSR-P.filtered.matrix")

#Load metadata files for each pool 
metadata_2 <- read.csv(
  file = "//csce.datastore.ed.ac.uk/csce/biology/groups/chambers/NGS_data_analysis/Sara/scale_bio_Sara/output_merged/samples/Pool2.QSR-P.allCells.csv",
  header = TRUE,
  row.names = 1
)

metadata_4 <- read.csv(
  file = "//csce.datastore.ed.ac.uk/csce/biology/groups/chambers/NGS_data_analysis/Sara/scale_bio_Sara/output_merged/samples/Pool4.QSR-P.allCells.csv",
  header = TRUE,
  row.names = 1
)

#Create Seurat objects for each pool 
pool2 <- CreateSeuratObject(
  counts = counts_2,
  assay = "RNA",
  meta.data = metadata_2
)
pool2


pool4 <- CreateSeuratObject(
  counts = counts_4,
  assay = "RNA",
  meta.data = metadata_4
)
pool4

```

### Merge Pools 2 and 4

```{r}
#Merge raw data into one single Seurat object
pool <- merge(pool2, y = pool4, add.cell.ids = c("pool2", "pool4"), project = "scalebio")

#Check number of cells to ensure objects have been correctly merged 
pool2
pool4
pool

#Merge layers together to create one big matrix intead of keeping them separate (Since these have been processed & sequenced together and contain different cells for the same samples)
pool <- JoinLayers(pool)
pool
```

### Clean up environment

```{r}
#Save and remove Pool2 & pool4 Seurat objects to free up space
setwd("//csce.datastore.ed.ac.uk/csce/biology/groups/chambers/NGS_data_analysis/Sara/scale_bio_Sara/seurat_objects")
saveRDS(pool2, file = "pool2_unfiltered.rds")
saveRDS(pool4, file = "pool4_unfiltered.rds")

rm(pool2)
rm(pool4)
rm(counts_2)
rm(counts_4)

```

### Select cells of interest

Samples to keep and associated ScalePlex well:

-   Tg2a+ (4A)

-   F12WT_rep1 (4H)

-   F12WT_rep2 (5A)

-   TbraKO_rep1 (5B)

-   TbraKO_rep2 (5C)

```{r}
Idents(pool) <- "assigned_scaleplex" #Set up scaleplex assigment as identities 
table(pool$assigned_scaleplex)

pool_filtered <- subset(pool, subset = assigned_scaleplex %in% c("4A", "4H", "5A", "5B", "5C")) #filter by scaleplex assigment

table(pool_filtered$assigned_scaleplex) # check that it's worked 
```

## QC

### Visualize standard QC metric 
```{r}
pool_filtered[["percent.mt"]] <- PercentageFeatureSet(pool_filtered, pattern = "^mt-", assay = "RNA") # calulcate percentage of mitochondial reads, all mitochondial genes start with "mt-"

#Visualize standard QC metric 
VlnPlot(pool_filtered, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = 0)

plot1 <- FeatureScatter(pool_filtered, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(pool_filtered, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1
plot2

```

### Filter low quality cells 
```{r}
pool_filtered_2 <- subset(
 x = pool_filtered,
   subset = 
   nCount_RNA < 25000 &
   nCount_RNA > 1500 &
   nFeature_RNA < 7000 &
   nFeature_RNA > 500 &
   percent.mt < 1.5 &
   percent.mt > 0.2

)
```

### Visualized quality metrics on filtered object 
```{r}
VlnPlot(pool_filtered_2, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = 0, split.by="assigned_scaleplex")

plot1 <- FeatureScatter(pool_filtered_2, feature1 = "nCount_RNA", feature2 = "percent.mt", group.by ="assigned_scaleplex")
plot2 <- FeatureScatter(pool_filtered_2, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by ="assigned_scaleplex")
plot1
plot2

#Check number of cells in each object
pool_filtered #14366 cells
pool_filtered_2 #13491 cells
#875 cells removed 


```

## Normalization & dimentionality reduction 
```{r}
#This command does 3 things: normalize and scale the data, and find top variable features 
pool_filtered_2 <- SCTransform(pool_filtered_2)
#PCA
pool_filtered_2 <- RunPCA(pool_filtered_2, layer = "SCT")
```

## Save object 

```{r}
setwd("//csce.datastore.ed.ac.uk/csce/biology/groups/chambers/NGS_data_analysis/Sara/scale_bio_Sara/seurat_objects")

saveRDS(pool_filtered_2, file = "tg2aplus_tbra_fk12_140126.rds")

```
